# 养老陪伴机器人双摄像头系统架构

## 文件结构

```
rppg/
├── backend/
│   ├── app.py                    # 主应用（双摄像头 + 联动逻辑）
│   ├── tablet_processor.py         # 平板摄像头处理模块
│   ├── projector_processor.py      # 投影交互处理模块
│   └── state_manager.py          # 状态管理和训练逻辑
│
├── frontend/
│   ├── pages/
│   │   ├── index.vue            # 平板端主界面（游戏选择）
│   │   ├── tablet.vue          # 平板端显示（平板控制界面）
│   │   └── training.vue       # 电脑端显示（投影训练界面）
│   └── app.vue               # 导航栏
│
└── docs/
    └── SYSTEM_ARCHITECTURE.md   # 本文档
```

## 系统概述

本系统通过双摄像头实现多模态感知，分为两个独立的摄像头模块：

### 1. 平板摄像头（网络）
- **功能**：rPPG 心率估计 + 情绪识别 + 姿态检测
- **设备**：安卓平板（荣耀平板）
- **连接方式**：局域网网络流（IP Webcam）
- **用途**：监测老人实时生理和心理状态

### 2. 投影摄像头（网络）
- **功能**：脚部交互检测 + 人体姿态 + 手势识别
- **设备**：安卓手机（IP Webcam）
- **连接方式**：局域网网络流（IP Webcam）
- **用途**：检测老人与地面投影内容的交互

---

## 系统架构

```
┌─────────────────────────────────────────────────────────┐
│              双摄像头感知系统                      │
├─────────────────────────────────────────────────────────┤
│                                                   │
│  平板摄像头（网络）        投影摄像头（网络）        │
│  http://10.117.42.45:8080/video  http://10.117.42.174:8080/video  │
│                                                   │
│  ┌─────────────────┐         ┌─────────────────┐  │
│  │  生理感知模块    │         │  交互感知模块    │  │
│  │ - rPPG 心率    │         │ - 人体姿态      │  │
│  │ - 情绪识别      │         │ - 脚部检测      │  │
│  │ - 姿态检测      │         │ - 脚踩踏检测    │  │
│  └────────┬────────┘         └────────┬────────┘  │
│           │                           │            │
│           └───────────┬───────────────┘            │
│                       │                            │
└───────────────────────┼────────────────────────────┘
                        │
                        ▼
              ┌─────────────────────────┐
              │      状态融合模块       │
              │ - 综合健康评估        │
              │ - 参与度计算          │
              │ - 训练难度调节        │
              └───────────┬───────────┘
                          │
          ┌───────────────┴───────────────┐
          │                              │
    ┌─────┴─────┐              ┌─────┴─────┐
    │  平板UI界面  │              │  投影训练界面 │
    │  (游戏选择）  │              │  (认知游戏）  │
    │             │              │             │
    │ - 游戏选择    │              │ - 色词游戏   │
    │ - 实时状态    │              │ - 交互反馈   │
    │ - 训练数据    │              │ - 难度调节   │
    │ - 推荐行动    │              │ - 成绩统计   │
    └─────┬─────┘              └─────┬─────┘
          │                            │
          └───────────┬────────────────┘
                      │
                      ▼
              联动控制逻辑
              （平板点击 → 投影显示）
```

---

## UI 界面设计

### 1. 平板端主界面（Home UI）

**访问地址**：`http://<电脑IP>:3000/`

**功能模块**：
- **游戏选择**
  - 色词游戏（可用）
  - 记忆游戏（禁用）
  - 反应测试（禁用）
  - 认知训练（禁用）

### 2. 平板控制界面（Tablet Control UI）

**访问地址**：`http://<电脑IP>:3000/tablet`

**功能模块**：
- **生理状态监测**
  - 心率（BPM）实时显示
  - 情绪状态（开心、中性、悲伤等）
  - 疲劳程度（低、中、高）
  - 注意力评分
  - 姿态状态（专注、放松、不良）
  - 综合健康评分

- **推荐行动**
  - 基于健康状态和参与度的智能建议
  - 优先级显示（高、中、低）

- **训练历史**
  - 历史训练记录
  - 训练模式、得分、时长、平均心率

### 3. 投影训练界面（Projected Training UI）

**显示方式**：通过投影仪投影到地面

**功能模块**：
- **色词游戏**
  - 开始按钮（踩 2 秒开始）
  - 颜色选择按钮（踩 0.5 秒选择）
  - 实时得分显示
  - 进度条显示
  - 正确/错误反馈

- **交互反馈**
  - 实时脚踩踏检测
  - 按钮进度圈显示
  - 正确/错误提示

---

## 联动逻辑

### 训练流程

1. **用户在平板端主界面选择游戏**
   ```
   平板UI → 点击"色词游戏" → 跳转到 /training
   ```

2. **用户在投影训练界面开始游戏**
   ```
   用户踩住"开始训练"按钮 2 秒
   按钮显示进度圈
   进度圈满后正式开始游戏
   ```

3. **进行色词匹配游戏**
   ```
   屏幕显示一个有颜色的字
   用户在按钮上踩（物理层面，踩和摸都统称）
   选择字的颜色，而不是字本身
   按钮显示进度圈（0.5秒）
   进度圈满后自动选择
   ```

4. **实时状态反馈**
   ```
   平板摄像头 → 采集 rPPG + 情绪 + 姿态
   投影摄像头 → 检测脚踩踏 + 交互
   状态融合 → 计算综合指标
   平板UI → 实时显示状态
   ```

---

## API 接口设计

### 平板控制接口

```
GET /api/physiological_state
{
  "bpm": 75,
  "emotion": "happy",
  "posture": "focused",
  "fatigue": "low",
  "attention": 85
}

GET /api/training_history
{
  "sessions": [
    {
      "date": "2025-01-15",
      "mode": "color_word",
      "score": 85,
      "duration": 120,
      "avg_bpm": 72
    }
  ]
}

POST /api/update_score
{
  "correct": true
}
```

### 投影训练接口

```
GET /api/interaction_state
{
  "person_detected": true,
  "body_position": {"x": 0.5, "y": 0.5},
  "gesture": "none",
  "gesture_confidence": 0.0,
  "interaction_target": "zone_1",
  "activity_level": "medium",
  "foot_detected": true,
  "foot_position": {"x": 0.5, "y": 0.8}
}
```

---

## 技术栈

### 后端
- Python 3.x
- Flask（Web 框架）
- OpenCV（图像处理）
- MediaPipe（姿态 + 手势识别）
- Scipy（信号处理）

### 前端
- Vue 3
- Nuxt 3
- CSS（样式）

---

## 开发计划

### 阶段一：基础功能 ✅
- [x] 平板摄像头连接（网络）
- [x] 平板摄像头处理（rPPG + 情绪 + 姿态）
- [x] 投影摄像头连接（网络）
- [x] 投影摄像头处理（姿态 + 脚部检测）
- [x] 平板端主界面（游戏选择）
- [x] 平板控制界面（状态监测）
- [x] 投影训练界面（色词游戏）
- [x] 状态管理模块
- [x] 训练控制逻辑

### 阶段二：联动功能 🚧
- [ ] 物理踩/摸交互（脚踩踏检测）
- [ ] 训练游戏开发（更多游戏类型）
- [ ] 数据统计和分析
- [ ] 性能优化
- [ ] 用户体验优化

---

## 项目最终目标

### 核心目标
为老年人提供基于双摄像头感知的认知训练系统，通过：
1. **平板摄像头**：监测生理状态（心率、情绪、疲劳）
2. **投影摄像头**：检测物理交互（脚踩踏、手势）
3. **状态融合**：综合评估健康状况和参与度
4. **自适应调节**：根据状态动态调整训练难度

### 应用场景
- **养老机构**：日常认知训练
- **家庭陪伴**：远程健康监测
- **康复中心**：认知康复训练

---

## 现在存在的问题

### 1. 物理踩/摸交互未实现
- **问题**：当前 `training.vue` 只有点击交互，没有实现物理踩/摸交互
- **需要**：连接投影摄像头的脚踩踏检测到前端
- **解决方案**：通过 WebSocket 或轮询 API 获取脚踩踏状态

### 2. 按钮进度圈未连接到物理交互
- **问题**：按钮进度圈只是视觉效果，没有连接到实际的脚踩踏检测
- **需要**：当检测到脚踩踏时，显示进度圈
- **解决方案**：监听 `interaction_state` API，当 `foot_detected` 为 true 时显示进度圈

### 3. 游戏逻辑未连接到物理交互
- **问题**：游戏逻辑仍然依赖点击事件，没有连接到物理踩踏
- **需要**：当脚踩踏进度圈满时，自动选择颜色
- **解决方案**：根据 `interaction_target` 自动选择颜色

### 4. 后端 API 需要完善
- **问题**：缺少一些必要的 API 接口
- **需要**：
  - `/api/interaction_state` - 返回脚踩踏状态
  - `/api/start_training` - 开始训练
  - `/api/stop_training` - 停止训练
- **解决方案**：完善 `app.py` 中的 API 接口

### 5. 训练历史数据未保存
- **问题**：`training_history.json` 文件存在，但没有实际保存数据
- **需要**：在训练结束时保存训练数据
- **解决方案**：在 `state_manager.py` 中实现训练历史保存逻辑

---

## 下一步计划

1. **实现物理踩/摸交互**
   - 连接投影摄像头的脚踩踏检测到前端
   - 实现按钮进度圈的物理交互反馈
   - 连接游戏逻辑到物理踩踏

2. **完善后端 API**
   - 实现 `/api/interaction_state` 接口
   - 实现 `/api/start_training` 接口
   - 实现 `/api/stop_training` 接口

3. **实现训练历史保存**
   - 在训练结束时保存训练数据
   - 在平板控制界面显示训练历史

4. **优化用户体验**
   - 添加音效反馈
   - 添加动画效果
   - 优化界面布局

---

**版本：** v2.0  
**更新日期：** 2025-01-15
