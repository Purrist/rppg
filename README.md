# 养老陪伴机器人双摄像头系统架构

## 文件结构

```
rppg/
├── backend/
│   ├── app.py                    # 主应用（双摄像头 + 联动逻辑）
│   ├── tablet_processor.py         # 平板摄像头处理模块
│   ├── screen_processor.py         # 外接摄像头处理模块
│   └── state_manager.py          # 状态管理和训练逻辑
│
├── frontend/
│   ├── pages/
│   │   ├── index.vue            # 平板端主界面（游戏选择）
│   │   ├── tablet.vue          # 平板端显示（平板控制界面）
│   │   ├── judge.vue            # 外接摄像头显示界面
│   │   └── training.vue       # 电脑端显示（投影训练界面）
│   └── app.vue               # 导航栏
│
├── .vscode/
│   └── launch.json    # 调试配置，在trae和vscode里都能一键启动
│   └── settings.json     # 解释器路径
└── docs/
    └── SYSTEM_ARCHITECTURE.md   # 本文档
```

## 系统概述

本系统通过双摄像头实现多模态感知，分为两个独立的摄像头模块：

### 1. 平板摄像头（网络）
- **功能**：rPPG 心率估计 + 情绪识别 + 姿态检测
- **设备**：安卓平板（荣耀平板）
- **连接方式**：局域网网络流（IP Webcam）
- **默认 URL**：`http://10.117.42.45:8080/video`
- **用途**：监测老人实时生理和心理状态
- **显示位置**：平板控制界面（tablet.vue）

### 2. 外接摄像头（网络）后续会考虑购买外接摄像头直接连接电脑
- **功能**：屏幕识别 + 认知训练互动
- **设备**：安卓手机（IP Webcam）
- **连接方式**：局域网网络流（IP Webcam）
- **默认 URL**：`http://10.117.42.174:8080/video`
- **用途**：检测认知训练互动，进行屏幕识别
- **显示位置**：外接摄像头显示界面（judge.vue）

### 摄像头配置优先级
1. **VS Code launch.json 配置**（最高优先级）
2. **命令行参数**
3. **app.py 中的默认配置**（最低优先级）

### 启动方式
- **开发调试**：使用 VS Code 的 "🚀 一键启动" 配置
- **配置修改**：修改 `launch.json` 中的 `args` 参数可以直接更改摄像头 URL

---

## 系统架构

```
┌─────────────────────────────────────────────────────────┐
│              双摄像头感知系统                      │
├─────────────────────────────────────────────────────────┤
│                                                   │
│  平板摄像头（网络）        投影摄像头（网络）        │
│  http://10.117.42.45:8080/video  http://10.117.42.174:8080/video  │
│                                                   │
│  ┌─────────────────┐         ┌─────────────────┐  │
│  │  生理感知模块    │         │  交互感知模块    │  │
│  │ - rPPG 心率    │         │ - 人体姿态      │  │
│  │ - 情绪识别      │         │ - 脚部检测      │  │
│  │ - 姿态检测      │         │ - 脚踩踏检测    │  │
│  └────────┬────────┘         └────────┬────────┘  │
│           │                           │            │
│           └───────────┬───────────────┘            │
│                       │                            │
└───────────────────────┼────────────────────────────┘
                        │
                        ▼
              ┌─────────────────────────┐
              │      状态融合模块       │
              │ - 综合健康评估        │
              │ - 参与度计算          │
              │ - 训练难度调节        │
              └───────────┬───────────┘
                          │
          ┌───────────────┴───────────────┐
          │                              │
    ┌─────┴─────┐              ┌─────┴─────┐
    │  平板UI界面  │              │  投影训练界面 │
    │  (游戏选择）  │              │  (认知游戏）  │
    │             │              │             │
    │ - 游戏选择    │              │ - 色词游戏   │
    │ - 实时状态    │              │ - 交互反馈   │
    │ - 训练数据    │              │ - 难度调节   │
    │ - 推荐行动    │              │ - 成绩统计   │
    └─────┬─────┘              └─────┬─────┘
          │                            │
          └───────────┬────────────────┘
                      │
                      ▼
              联动控制逻辑
              （平板点击 → 投影显示）
```

---

## UI 界面设计

### 1. 平板端主界面（Home UI）

**访问地址**：`http://<电脑IP>:3000/`

**功能模块**：
- **游戏选择**
  - 色词游戏（可用）
  - 记忆游戏（禁用）
  - 反应测试（禁用）
  - 认知训练（禁用）

### 2. 平板控制界面（Tablet Control UI）

**访问地址**：`http://<电脑IP>:3000/tablet`

**功能模块**：
- **生理状态监测**
  - 心率（BPM）实时显示
  - 情绪状态（开心、中性、悲伤等）
  - 疲劳程度（低、中、高）
  - 注意力评分
  - 姿态状态（专注、放松、不良）
  - 综合健康评分

- **推荐行动**
  - 基于健康状态和参与度的智能建议
  - 优先级显示（高、中、低）

- **训练历史**
  - 历史训练记录
  - 训练模式、得分、时长、平均心率

### 3. 投影训练界面（Projected Training UI）

**显示方式**：通过投影仪投影到地面

**功能模块**：
- **色词游戏**
  - 开始按钮（踩 2 秒开始）
  - 颜色选择按钮（踩 0.5 秒选择）
  - 实时得分显示
  - 进度条显示
  - 正确/错误反馈

- **交互反馈**
  - 实时脚踩踏检测
  - 按钮进度圈显示
  - 正确/错误提示

---

## 联动逻辑

### 训练流程

1. **用户在平板端主界面选择游戏**
   ```
   平板UI → 点击"色词游戏" → 跳转到 /training
   ```

2. **用户在投影训练界面开始游戏**
   ```
   用户踩住"开始训练"按钮 2 秒
   按钮显示进度圈
   进度圈满后正式开始游戏
   ```

3. **进行色词匹配游戏**
   ```
   屏幕显示一个有颜色的字
   用户在按钮上踩（物理层面，踩和摸都统称）
   选择字的颜色，而不是字本身
   按钮显示进度圈（0.5秒）
   进度圈满后自动选择
   ```

4. **实时状态反馈**
   ```
   平板摄像头 → 采集 rPPG + 情绪 + 姿态
   投影摄像头 → 检测脚踩踏 + 交互
   状态融合 → 计算综合指标
   平板UI → 实时显示状态
   ```

---

## API 接口设计

### 平板控制接口

```
GET /api/physiological_state
{
  "bpm": 75,
  "emotion": "happy",
  "posture": "focused",
  "fatigue": "low",
  "attention": 85
}

GET /api/training_history
{
  "sessions": [
    {
      "date": "2025-01-15",
      "mode": "color_word",
      "score": 85,
      "duration": 120,
      "avg_bpm": 72
    }
  ]
}

POST /api/update_score
{
  "correct": true
}
```

### 投影训练接口

```
GET /api/interaction_state
{
  "person_detected": true,
  "body_position": {"x": 0.5, "y": 0.5},
  "gesture": "none",
  "gesture_confidence": 0.0,
  "interaction_target": "zone_1",
  "activity_level": "medium",
  "foot_detected": true,
  "foot_position": {"x": 0.5, "y": 0.8}
}
```

---

## 技术栈

### 后端
- Python 3.x
- Flask（Web 框架）
- OpenCV（图像处理）
- MediaPipe（姿态 + 手势识别）
- Scipy（信号处理）

### 前端
- Vue 3
- Nuxt 3
- CSS（样式）

---

## 开发计划

### 阶段一：基础功能 ✅
- [x] 平板摄像头连接（网络）
- [x] 平板摄像头处理（rPPG + 情绪 + 姿态）
- [x] 投影摄像头连接（网络）
- [x] 投影摄像头处理（姿态 + 脚部检测）
- [x] 平板端主界面（游戏选择）
- [x] 平板控制界面（状态监测）
- [x] 投影训练界面（色词游戏）
- [x] 状态管理模块
- [x] 训练控制逻辑

### 阶段二：联动功能 🚧
- [ ] 物理踩/摸交互（脚踩踏检测）
- [ ] 训练游戏开发（更多游戏类型）
- [ ] 数据统计和分析
- [ ] 性能优化
- [ ] 用户体验优化

---

## 项目最终目标

### 核心目标
为老年人提供基于双摄像头感知的认知训练系统，通过：
1. **平板摄像头**：监测生理状态（心率、情绪、疲劳）
2. **投影摄像头**：检测物理交互（脚踩踏、手势）
3. **状态融合**：综合评估健康状况和参与度
4. **自适应调节**：根据状态动态调整训练难度

### 应用场景
- **养老机构**：日常认知训练
- **家庭陪伴**：远程健康监测
- **康复中心**：认知康复训练

---

## 当前实现状态

### 1. 物理踩/摸交互已实现
- **实现情况**：已通过手部遮挡检测实现物理踩/摸交互
- **技术细节**：
  - 后端 `screen_processor.py` 实现了手部遮挡检测
  - 前端 `training.vue` 通过轮询 `/api/interaction_state` 获取交互状态
  - 当检测到手部遮挡某区域 ≥ 2 秒时，自动选择对应选项

### 2. 后端 API 已完善
- **实现情况**：
  - `/api/interaction_state` - 已实现，返回脚踩踏状态
  - `/api/start_training` - 已实现，开始训练
  - `/api/stop_training` - 已实现，停止训练
  - `/api/fused_state` - 已实现，返回融合状态
  - `/api/training_history` - 已实现，返回训练历史

### 3. 训练历史数据已保存
- **实现情况**：`state_manager.py` 已实现训练历史保存逻辑
- **技术细节**：
  - 训练结束时自动保存训练数据到 `training_history.json`
  - 支持获取历史记录（默认返回最近10条）
  - 包含日期、模式、难度、时长、得分、正确率等信息

### 4. 游戏逻辑已连接到物理交互
- **实现情况**：
  - 游戏逻辑已从依赖点击事件改为依赖物理交互
  - 当检测到脚踩踏（模拟）时，自动触发选择逻辑
  - 支持实时反馈和状态更新

## 现在存在的问题

### 1. 按钮进度圈未完全连接到物理交互
- **问题**：按钮进度圈只是视觉效果，没有完全连接到实际的脚踩踏检测
- **需要**：当检测到脚踩踏时，动态显示进度圈
- **解决方案**：监听 `interaction_state` API，根据 `selection_confidence` 显示进度圈

### 2. 多种训练游戏未实现
- **问题**：当前只有色词游戏，没有实现其他训练游戏
- **需要**：开发更多训练游戏类型
- **解决方案**：添加记忆游戏、反应测试等游戏模式

### 3. 数据统计和分析功能缺失
- **问题**：缺乏对训练数据的统计和分析
- **需要**：实现数据可视化和分析功能
- **解决方案**：在平板控制界面添加数据统计模块

### 4. 用户体验优化
- **问题**：界面设计和交互体验有待优化
- **需要**：添加音效反馈、动画效果等
- **解决方案**：优化前端界面设计和交互逻辑

---

## 下一步计划

1. **完善按钮进度圈交互**
   - 连接按钮进度圈到实际的脚踩踏检测
   - 根据 `selection_confidence` 动态更新进度圈

2. **开发更多训练游戏**
   - 添加记忆游戏
   - 添加反应测试游戏
   - 添加认知训练游戏

3. **实现数据统计和分析**
   - 在平板控制界面添加数据统计模块
   - 实现训练数据可视化
   - 添加训练建议生成功能

4. **优化用户体验**
   - 添加音效反馈
   - 添加动画效果
   - 优化界面布局和响应式设计

5. **性能优化**
   - 优化摄像头处理算法
   - 优化前端渲染性能
   - 优化 API 响应速度

## 已完成的开发计划

### 阶段一：基础功能 ✅
- [x] 平板摄像头连接（网络）
- [x] 平板摄像头处理（rPPG + 情绪 + 姿态）
- [x] 投影摄像头连接（网络）
- [x] 投影摄像头处理（姿态 + 脚部检测）
- [x] 平板端主界面（游戏选择）
- [x] 平板控制界面（状态监测）
- [x] 投影训练界面（色词游戏）
- [x] 状态管理模块
- [x] 训练控制逻辑

### 阶段二：联动功能 ✅
- [x] 物理踩/摸交互（脚踩踏检测）
- [ ] 训练游戏开发（更多游戏类型）
- [ ] 数据统计和分析
- [ ] 性能优化
- [ ] 用户体验优化

---

## 手机摄像头替代方案说明

### 为什么使用手机摄像头
1. **硬件限制**：当前阶段没有投影仪和外接摄像头，需要寻找替代方案
2. **双摄像头需求**：系统需要两个摄像头（平板摄像头和投影摄像头）来实现完整功能
3. **网络摄像头优势**：手机 IP Webcam 可以通过局域网传输视频流，便于系统集成和调试

### 手机摄像头替代方案
1. **平板端摄像头替代**：
   - 使用手机 IP Webcam 应用将手机摄像头转为网络摄像头
   - 通过局域网传输视频流到后端系统
   - 用于 rPPG 心率估计、情绪识别和姿态检测

2. **投影摄像头替代**：
   - 使用手机 IP Webcam 作为外接摄像头
   - 通过局域网传输视频流到后端系统
   - 用于屏幕识别和认知训练互动

3. **交互方式替代**：
   - 使用电脑屏幕模拟地面投影
   - 用户用手遮挡某一区域 ≥ 2 秒等价于"脚踩投影区域"
   - 电脑自带摄像头识别人与屏幕 UI 的交互

### 技术实现
- **手机端**：安装 IP Webcam 应用，设置局域网访问
- **后端**：通过 OpenCV 读取手机摄像头的网络流
- **前端**：通过 API 接口获取摄像头处理结果和交互状态

### 连接配置
- **默认 URL**：
  - 平板摄像头：`http://10.117.42.45:8080/video`
  - 投影摄像头：`http://10.117.42.174:8080/video`
- **配置优先级**：
  1. VS Code launch.json 配置（最高优先级）
  2. 命令行参数
  3. app.py 中的默认配置（最低优先级）

### 未来硬件迁移
- 当投影仪和外接摄像头到位后，可以直接替换手机摄像头
- 系统架构和接口设计支持无缝迁移
- 只需要修改摄像头 URL 配置即可切换到实际硬件