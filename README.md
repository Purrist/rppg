# 双摄像头感知系统使用指南

## 🚀 快速开始

### 第一步：启动平板上的 IP Webcam

1. 在平板（荣耀平板）上打开 **IP Webcam** 应用
2. 点击 **"Start Server"** 按钮
3. 记录显示的 URL，例如：`http://10.117.42.45:8080/video`

### 第二步：启动安卓手机上的 IP Webcam

1. 在安卓手机上打开 **IP Webcam** 应用
2. 点击 **"Start Server"** 按钮
3. 记录显示的 URL，例如：`http://10.117.42.174:8080/video`

### 第三步：启动系统

在 VS Code 中，按 `F5` 或点击运行按钮，选择 **"🚀 一键启动（批处理脚本）"**

系统会自动：
- ✅ 启动后端服务（Python Flask）
- ✅ 启动前端服务（Nuxt）
- ✅ 连接平板摄像头（网络）
- ✅ 连接投影摄像头（安卓手机）
- ✅ 显示所有访问地址

---

## 📱 访问地址

启动成功后，终端会显示：

```
============================================================
    双摄像头感知系统 - 一键启动
============================================================

[配置信息]
平板摄像头: http://10.117.42.45:8080/video
投影摄像头: http://10.117.42.174:8080/video

[启动服务]
[系统] 状态管理器已初始化
[系统] 平板摄像头已启动
[系统] 投影摄像头已启动

============================================================
双摄像头感知系统启动成功！
============================================================

📡 局域网访问地址:
   平板端主界面: http://<你的电脑IP>:3000/
   平板控制界面: http://<你的电脑IP>:3000/tablet
   投影训练界面: http://<你的电脑IP>:3000/training

⚙️  后端 API 地址:
   http://<你的电脑IP>:8080

📹 视频流:
   平板摄像头: http://<你的电脑IP>:8080/tablet_video_feed
   投影摄像头: http://<你的电脑IP>:8080/projector_video_feed

📊 API 接口:
   生理状态: http://<你的电脑IP>:8080/api/physiological_state
   交互状态: http://<你的电脑IP>:8080/api/interaction_state
   融合状态: http://<你的电脑IP>:8080/api/fused_state
============================================================
```

---

## 📱 界面说明

### 平板端主界面（http://<电脑IP>:3000/）

**功能模块：**
- **游戏选择**
  - 色词游戏（可用）
  - 记忆游戏（禁用）
  - 反应测试（禁用）
  - 认知训练（禁用）

### 平板控制界面（http://<电脑IP>:3000/tablet）

**功能模块：**
- **生理状态监测**
  - 心率（BPM）实时显示
  - 情绪状态（开心、中性、悲伤等）
  - 疲劳程度（低、中、高）
  - 注意力评分
  - 姿态状态（专注、放松、不良）
  - 综合健康评分

- **推荐行动**
  - 基于健康状态和参与度的智能建议
  - 优先级显示（高、中、低）

- **训练历史**
  - 历史训练记录
  - 训练模式、得分、时长、平均心率

### 投影训练界面（http://<电脑IP>:3000/training）

**功能模块：**
- **色词游戏**
  - 开始按钮（踩 2 秒开始）
  - 颜色选择按钮（踩 0.5 秒选择）
  - 实时得分显示
  - 进度条显示
  - 正确/错误反馈

- **交互反馈**
  - 实时脚踩踏检测
  - 按钮进度圈显示
  - 正确/错误提示

---

## 🎯 使用流程

### 训练流程

1. **在平板端主界面选择游戏**
   - 点击"色词游戏"进入投影训练界面

2. **在投影训练界面开始游戏**
   - 用户踩住"开始训练"按钮 2 秒
   - 按钮显示进度圈
   - 进度圈满后正式开始游戏

3. **进行色词匹配游戏**
   - 屏幕显示一个有颜色的字
   - 用户在按钮上踩（物理层面，踩和摸都统称）
   - 选择字的颜色，而不是字本身
   - 按钮显示进度圈（0.5秒）
   - 进度圈满后自动选择

4. **实时状态反馈**
   - 平板摄像头监测心率、情绪、疲劳
   - 系统根据状态自动调节训练难度
   - 在平板控制界面显示实时数据

---

## 🔧 配置说明

### 修改平板摄像头 URL

如果需要修改平板摄像头 URL，编辑 `start_system.bat` 文件：

```batch
set TABLET_URL=http://<新的平板IP>:8080/video
```

### 修改投影摄像头 URL

如果需要修改投影摄像头 URL，编辑 `start_system.bat` 文件：

```batch
set PROJECTOR_URL=http://<新的手机IP>:8080/video
```

---

## 📊 系统功能

### 平板摄像头功能
- ✅ rPPG 心率估计（3点 ROI 动态选取）
- ✅ 情绪识别（基于面部特征点分析）
- ✅ 疲劳检测（基于眼睛开合度）
- ✅ 姿态检测（基于头部和肩膀角度）

### 投影摄像头功能
- ✅ 人体姿态检测（33 个关键点）
- ✅ 手势识别（指向、胜利、拳头、张开手掌）
- ✅ 脚部检测（基于脚踝和脚尖关键点）
- ✅ 脚踩踏检测（6 个预设区域）
- ✅ 活动水平评估

### 状态融合功能
- ✅ 综合健康评分（心率 + 疲劳 + 情绪）
- ✅ 参与度计算（注意力 + 活动 + 交互）
- ✅ 认知负荷评估
- ✅ 自适应调节建议

### 训练控制功能
- ✅ 训练模式管理
- ✅ 难度动态调节
- ✅ 实时分数统计
- ✅ 训练历史记录

---

## 💡 使用提示

1. **网络连接**
   - 确保平板和电脑在同一 Wi-Fi 网络
   - 确保安卓手机和电脑在同一 Wi-Fi 网络
   - 确保 IP Webcam 应用保持运行

2. **光线条件**
   - 平板摄像头需要充足且稳定的光线
   - 投影区域需要良好的照明条件

3. **摄像头位置**
   - 平板摄像头应正对用户面部
   - 安卓手机摄像头应能清晰看到电脑屏幕

4. **训练建议**
   - 保持面部在平板摄像头视野内
   - 避免大幅度头部运动
   - 等待 BPM 数值稳定（约 5-10 秒）

---

## 🛑️ 故障排除

### 问题：平板摄像头无法连接

**解决方案：**
1. 检查平板和电脑是否在同一 Wi-Fi 网络
2. 检查平板 IP 地址是否正确
3. 确保 IP Webcam 应用正在运行
4. 尝试在平板上重启 IP Webcam 应用

### 问题：投影摄像头无法连接

**解决方案：**
1. 检查安卓手机和电脑是否在同一 Wi-Fi 网络
2. 检查安卓手机 IP 地址是否正确
3. 确保 IP Webcam 应用正在运行
4. 尝试在安卓手机上重启 IP Webcam 应用

### 问题：前端无法访问

**解决方案：**
1. 检查前端服务是否正常启动
2. 检查端口 3000 是否被占用
3. 尝试在浏览器中直接访问 `http://localhost:3000`

### 问题：心率检测不准确

**解决方案：**
1. 确保光线充足且稳定
2. 保持面部在平板摄像头视野内
3. 避免大幅度头部运动
4. 等待 BPM 数值稳定（约 5-10 秒）

---

## 📁 文件结构

```
rppg/
├── backend/
│   ├── app.py                    # 主应用
│   ├── tablet_processor.py         # 平板摄像头模块
│   ├── projector_processor.py      # 投影交互模块
│   └── state_manager.py          # 状态管理模块
├── frontend/
│   ├── pages/
│   │   ├── index.vue            # 平板端主界面（游戏选择）
│   │   ├── tablet.vue          # 平板端显示（平板控制界面）
│   │   └── training.vue       # 电脑端显示（投影训练界面）
│   └── app.vue                   # 导航栏
├── start_system.bat              # 一键启动脚本
├── .vscode/
│   └── launch.json              # 启动配置
└── docs/
    ├── SYSTEM_ARCHITECTURE.md    # 系统架构文档
    └── README.md                   # 使用指南（本文件）
```

---

## 🎯 项目最终目标

### 核心目标
为老年人提供基于双摄像头感知的认知训练系统，通过：
1. **平板摄像头**：监测生理状态（心率、情绪、疲劳）
2. **投影摄像头**：检测物理交互（脚踩踏、手势）
3. **状态融合**：综合评估健康状况和参与度
4. **自适应调节**：根据状态动态调整训练难度

### 应用场景
- **养老机构**：日常认知训练
- **家庭陪伴**：远程健康监测
- **康复中心**：认知康复训练

---

## ✅ 现在已完成的阶段性目标

### 阶段一：基础功能 ✅
- [x] 平板摄像头连接（网络）
- [x] 平板摄像头处理（rPPG + 情绪 + 姿态）
- [x] 投影摄像头连接（网络）
- [x] 投影摄像头处理（姿态 + 脚部检测）
- [x] 平板端主界面（游戏选择）
- [x] 平板控制界面（状态监测）
- [x] 投影训练界面（色词游戏）
- [x] 状态管理模块
- [x] 训练控制逻辑

### 阶段二：联动功能 🚧
- [ ] 物理踩/摸交互（脚踩踏检测）
- [ ] 训练游戏开发（更多游戏类型）
- [ ] 数据统计和分析
- [ ] 性能优化
- [ ] 用户体验优化

---

## ⚠️ 现在存在的问题

### 1. 物理踩/摸交互未实现
- **问题**：当前 `training.vue` 只有点击交互，没有实现物理踩/摸交互
- **需要**：连接投影摄像头的脚踩踏检测到前端
- **解决方案**：通过 WebSocket 或轮询 API 获取脚踩踏状态

### 2. 按钮进度圈未连接到物理交互
- **问题**：按钮进度圈只是视觉效果，没有连接到实际的脚踩踏检测
- **需要**：当检测到脚踩踏时，显示进度圈
- **解决方案**：监听 `interaction_state` API，当 `foot_detected` 为 true 时显示进度圈

### 3. 游戏逻辑未连接到物理交互
- **问题**：游戏逻辑仍然依赖点击事件，没有连接到物理踩踏
- **需要**：当脚踩踏进度圈满时，自动选择颜色
- **解决方案**：根据 `interaction_target` 自动选择颜色

### 4. 后端 API 需要完善
- **问题**：缺少一些必要的 API 接口
- **需要**：
  - `/api/interaction_state` - 返回脚踩踏状态
  - `/api/start_training` - 开始训练
  - `/api/stop_training` - 停止训练
- **解决方案**：完善 `app.py` 中的 API 接口

### 5. 训练历史数据未保存
- **问题**：`training_history.json` 文件存在，但没有实际保存数据
- **需要**：在训练结束时保存训练数据
- **解决方案**：在 `state_manager.py` 中实现训练历史保存逻辑

### 6. 前端编译错误
- **问题**：`training.vue` 中 `showFeedback` 变量重复声明
- **需要**：修复变量命名冲突
- **解决方案**：将函数 `showFeedback` 重命名为 `displayFeedback`

---

## 📞 技术支持

如有问题，请查看：
- 系统架构文档：`docs/SYSTEM_ARCHITECTURE.md`
- 代码文件：`backend/` 目录
- 前端文件：`frontend/` 目录

---

**版本：** v2.0  
**更新日期：** 2025-01-15
